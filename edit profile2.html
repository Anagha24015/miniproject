<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit Profile</title>
  <style>
    body {
        margin: 0;
        font-family: 'Segoe UI', sans-serif;
        background-image: url('https://png.pngtree.com/png-vector/20220610/ourmid/pngtree-world-map-silhouette-vector-australia-png-image_4955918.png');
        background-repeat: no-repeat;
        background-size: 100% auto;
    
    }

    .top-banner {
        height: 200px;
        background-image: url('https://poonawallafincorp.com/documents/213163/213167/blog_banner-banner-image-checklist-of-things-to-carry-while-travelling-for-a-seamless-experience.jpg');
        background-repeat: no-repeat;
        background-position: center;
        background-size: 100% auto;
        display: flex;
        margin-top: 0px;
        flex-direction: column;
        justify-content: center;
        color: rgb(250, 246, 246);
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    .logo {
        font-size: 90px;
        font-style: italic;
        margin-left: 40px;
        margin-top:7px;
    }

    .nav {
        display:flex;
        gap: 20px;
        font-weight: bold;
        font-size: 20px;
        margin-top: 30px;
        margin-left: auto;
        margin-right: 100px;
        color:white;
    }

    .nav :hover {
        cursor: pointer;
    }




    .profile-container {
      background: #fff;
      padding: 30px 40px;
      border-radius: 15px;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
      width: 450px;
      margin-left:500px;
      margin-top:100px;
    }

    h2 {
      text-align: center;
      margin-bottom: 25px;
      color: #333;
    }

    .form-group {
      margin-bottom: 20px;
      position: relative;
    }

    label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
    }

    input, select {
      /*width: calc(100% - 60px);*/
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 10px;
      min-width: 400px;
      flex:1
      
    }

    .edit-btn {
      position: absolute;
      right: 50px;
      top: 30px;
      padding: 5px 10px;
      font-size: 12px;
      background-color: #4e73df;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .cancel-btn {
      position: absolute;
      right: -9px;
      top: 30px;
      padding: 5px 10px;
      font-size: 12px;
      background-color: #f96363;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: none;
      
    }

    .edit-btn:hover {
      background-color: #2e59d9;
      
    }

    .cancel-btn:hover {
      background-color: #dc3545;
      
    }

    .save-btn {
      width: 100%;
      padding: 12px;
      background-color: #e6c804;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
    }

    .save-btn:hover {
      background-color: #f9cb15;
    }

    .error {
      color: red;
      font-size: 13px;
      margin-top: 4px;
    }


/*profile icon*/

.profile-dropdown {
    position: relative;
    display: inline-block;
}

.profile-icon {
    font-size: 30px;
    cursor: pointer;
    color: white;
    margin-left:1430px;
    height:60px;
    width:60px;
    margin-top:-30px;
}

.dropdown-menu {
    display: none;
    position: absolute;
    right: 0;
    top: 40px;
    background-color: white;
    min-width: 150px;
    box-shadow: 0px 4px 6px rgba(0,0,0,0.2);
    z-index: 1;
    border-radius: 8px;
    overflow: hidden;
    color: #333;
    padding: 15px 15px;
    text-decoration: none;
}

.dropdown-menu span {
    display:inline-block;
    padding: 5px 18px;
    margin: 0;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.2s;
}

.dropdown-menu span:hover {
    background-color: #f0f0f0;
}

footer {
            text-align: center;
            padding: 20px;
            background-color: #f1f1f1;
            margin-top: 40px;
            font-size: 14px;
            color: #777;
}

/* Add this new style for row alignment */
.form-row {
  display: flex;
  align-items: center;
  gap: 10px;
}

.form-row input,
.form-row select {
  flex: 1;
  height: 44px;
  padding: 0 12px;
  font-size: 1rem;
  border-radius: 10px;
  border: 1px solid #ccc;
  min-width: 0;
  box-sizing: border-box;
}

.form-row .edit-btn,
.form-row .cancel-btn {
  height: 36px;
  min-width: 60px;
  font-size: 1rem;
  border-radius: 6px;
  border: none;
  margin-left: 8px;
  position: static;
}

.delete-btn{
  width: 100%;
      padding: 12px;
      background-color: #ee1409;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
}

.delete-btn:hover{
  background-color:orange;
}
  </style>
</head>
<body>
    <!-- Add Firebase JS SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBVwjZ7HbypfVy_HI-e30EmN9xBXbRREdo",
        authDomain: "ai-travel-packing-assistant.firebaseapp.com",
        projectId: "ai-travel-packing-assistant",
        storageBucket: "ai-travel-packing-assistant.appspot.com",
        messagingSenderId: "1096528973272",
        appId: "1:1096528973272:web:cefe3f2cc51e096ffb76ad"
      };
      firebase.initializeApp(firebaseConfig);
    </script>

    <div class="top-banner">
        <div class="logo">BONVOYAGE</div>
        <div class="nav">
            <span onclick="goHome()">Home</span>
            <span onclick="faq()">FAQ</span>
            <span onclick="blogs()">Blogs</span>
            <span onclick="contact()">Contact</span>
        </div>
    </div>

    <div class="profile-dropdown">
        <img src="https://icon-library.com/images/contact-icon-png/contact-icon-png-5.jpg" class="profile-icon" onclick="toggleDropdown()" alt="Profile">

        <div class="dropdown-menu" id="dropdownMenu">
            <span onclick="editprofile()"> Edit Profile </span><br>
            <span onclick="logout()"> Logout </span>
        </div>
    </div>


<div class="profile-container">
  <h2>Edit Profile</h2>
  <form id="editProfileForm">
    <div class="form-group">
      <label for="username">Username</label>
      <div class="form-row">
        <input type="text" id="username" disabled>
        <button type="button" class="edit-btn" onclick="enableField('username')">Edit</button>
        <button type="button" class="cancel-btn" onclick="cancelEdit('username')">Cancel</button>
      </div>
      <div class="error" id="usernameError"></div>
    </div>

    <div class="form-group">
      <label for="email">Email</label>
      <div class="form-row">
        <input type="email" id="email" disabled>
        <button type="button" class="edit-btn" onclick="enableField('email')">Edit</button>
        <button type="button" class="cancel-btn" onclick="cancelEdit('email')">Cancel</button>
      </div>
      <div class="error" id="emailError"></div>
    </div>

    <div class="form-group">
      <label for="phone">Phone Number</label>
      <div class="form-row">
        <input type="tel" id="phone" disabled>
        <button type="button" class="edit-btn" onclick="enableField('phone')">Edit</button>
        <button type="button" class="cancel-btn" onclick="cancelEdit('phone')">Cancel</button>
      </div>
      <div class="error" id="phoneError"></div>
    </div>

    <div class="form-group">
      <label for="gender">Gender</label>
      <div class="form-row">
        <select id="gender" disabled>
          <option value="" disabled selected>Select Gender</option>
          <option>Female</option>
          <option>Male</option>
          <option>Other</option>
        </select>
        <button type="button" class="edit-btn" onclick="enableField('gender')">Edit</button>
        <button type="button" class="cancel-btn" onclick="cancelEdit('gender')">Cancel</button>
      </div>
    </div>

    <div class="form-group">
      <label for="password">Password</label>
      <div class="form-row">
        <input type="password" id="password" disabled>
        <button type="button" class="edit-btn" onclick="enableField('password')">Edit</button>
        <button type="button" class="cancel-btn" onclick="cancelEdit('password')">Cancel</button>
      </div>
      <div class="error" id="passwordError"></div>
    </div>

    <button type="submit" class="save-btn">Save Changes</button><br><br>
    <button type="button" class="delete-btn" onclick="deleteProfile()">Delete Profile</button>
  </form>
</div>

<script>
  const originalValues = {
    username: '',
    email: '',
    phone: '',
    gender: '',
    password: ''
  };

  function enableField(fieldId) {
    const input = document.getElementById(fieldId);
    input.disabled = false;
    input.focus();

    const cancelBtn = input.parentElement.querySelector('.cancel-btn');
    cancelBtn.style.display = 'inline-block';
  }

  function cancelEdit(fieldId) {
    const input = document.getElementById(fieldId);
    input.value = originalValues[fieldId];
    input.disabled = true;

    const cancelBtn = input.parentElement.querySelector('.cancel-btn');
    cancelBtn.style.display = 'none';

    const error = document.getElementById(fieldId + 'Error');
    if (error) error.innerText = '';
  }

  document.getElementById("editProfileForm").addEventListener("submit", function (e) {
    console.log("[DEBUG] Save Changes button clicked");
    e.preventDefault();

    let valid = true;

    const username = document.getElementById("username").value.trim();
    if (!/^[A-Za-z0-9]{3,}$/.test(username)) {
      document.getElementById("usernameError").innerText = "Username must be at least 3 characters.";
      valid = false;
    } else {
      document.getElementById("usernameError").innerText = "";
    }

    const email = document.getElementById("email").value.trim();
    if (!/^[\w.-]+@[\w.-]+\.\w+$/.test(email)) {
      document.getElementById("emailError").innerText = "Invalid email format.";
      valid = false;
    } else {
      document.getElementById("emailError").innerText = "";
    }

    const phone = document.getElementById("phone").value.trim();
    if (!/^\d{10}$/.test(phone)) {
      document.getElementById("phoneError").innerText = "Phone must be 10 digits.";
      valid = false;
    } else {
      document.getElementById("phoneError").innerText = "";
    }

    const password = document.getElementById("password").value;
    const passError = document.getElementById("passwordError");
    const passwordPattern = /^(?=.*[A-Z])(?=.*[a-z])(?=.*[\d])(?=.*[@#$%&*?!])[A-Za-z\d@#$%&*?!]{8,}$/;
    if (password) {
      if (!passwordPattern.test(password)) {
        passError.innerText = "Password must be 8+ characters with upper, lower, digit, special char.";
        valid = false;
      } else {
        passError.innerText = "";
      }
    } else {
      passError.innerText = "";
    }

    const gender = document.getElementById("gender").value;

    if (valid) {
      console.log("[DEBUG] Validation passed");
      firebase.auth().onAuthStateChanged(function(user) {
        console.log("[DEBUG] onAuthStateChanged user:", user);
        if (!user) {
          alert("You are not logged in. Please log in again.");
          window.location.href = 'myproject design 2.html';
          return;
        }
        const updatedUser = {
          username: username,
          email: email,
          mobile: phone,
          gender: gender,
          password: password
        };
        // Update Firebase Auth if email or password changed
        const idToken = localStorage.getItem("firebaseIdToken");
        const userProfile = JSON.parse(localStorage.getItem("userProfile"));
        const currentEmail = userProfile?.email || "";
        const currentPassword = userProfile?.password || "";
        let reauthPromise = Promise.resolve();
        if (email !== currentEmail || (password && password !== currentPassword)) {
          console.log("[DEBUG] Email or password changed, need re-authentication");
          const currentPwd = prompt("For security, please enter your current password to confirm changes:");
          if (!currentPwd) {
            alert("Password is required to update email or password.");
            console.log("[DEBUG] No current password entered, aborting");
            return;
          }
          const credential = firebase.auth.EmailAuthProvider.credential(
            currentEmail,
            currentPwd
          );
          console.log("[DEBUG] Attempting re-authentication...");
          reauthPromise = user.reauthenticateWithCredential(credential);
        } else {
          console.log("[DEBUG] No email or password change, skipping re-authentication");
        }
        reauthPromise
          .then(() => {
            console.log("[DEBUG] Re-authentication successful or not needed");
            const promises = [];
            let passwordChanged = false;
            if (email !== currentEmail) {
              console.log("[DEBUG] Updating email in Firebase Auth");
              promises.push(user.updateEmail(email));
            }
            if (password && password !== currentPassword) {
              console.log("[DEBUG] Updating password in Firebase Auth");
              passwordChanged = true;
              promises.push(user.updatePassword(password));
            }
            return Promise.all(promises).then(() => passwordChanged);
          })
          .then((passwordChanged) => {
            console.log("[DEBUG] Firebase Auth update complete, passwordChanged:", passwordChanged);
            // After Firebase Auth update, update backend
            if (passwordChanged) {
              updatedUser.password = password;
            }
            localStorage.setItem("userProfile", JSON.stringify(updatedUser));
            if (idToken) {
              console.log("[DEBUG] Sending updated profile to backend");
              fetch('http://localhost:5000/api/profile', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + idToken
                },
                body: JSON.stringify({
                  name: updatedUser.username,
                  preferences: {
                    mobile: updatedUser.mobile,
                    gender: updatedUser.gender
                  }
                })
              })
              .then(response => response.json())
              .then(data => {
                console.log("[DEBUG] Backend update successful");
                alert("Successfully edited");
                alert("Profile updated successfully!");
              })
              .catch(err => {
                console.error("Backend update failed:", err);
                alert("Profile update failed: " + (err.message || err));
              });
            } else {
              alert("No authentication token found. Please log in again.");
              console.log("[DEBUG] No idToken found");
            }
          })
          .catch((error) => {
            console.error("Firebase Auth update failed:", error);
            if (error && error.message) {
              alert("Failed to update Firebase Auth: " + error.message);
            } else {
              alert("Failed to update Firebase Auth. Please check the console for details.");
            }
          });
      });
    } else {
      console.log("[DEBUG] Validation failed");
    }
  });

  // Load and prefill values from localStorage
window.onload = function () {
  const idToken = localStorage.getItem("firebaseIdToken");
  if (idToken) {
    fetch('http://localhost:5000/api/profile', {
      method: 'GET',
      headers: {
        'Authorization': 'Bearer ' + idToken
      }
    })
    .then(response => response.json())
    .then(userProfile => {
      localStorage.setItem("userProfile", JSON.stringify(userProfile));
      if (userProfile) {
        document.getElementById("username").value = userProfile.name || '';
        document.getElementById("email").value = userProfile.email || '';
        document.getElementById("phone").value = userProfile.preferences?.mobile || '';
        document.getElementById("gender").value = userProfile.preferences?.gender || '';
        document.getElementById("password").value = '';
        // Save originals for cancel
        originalValues.username = userProfile.name || '';
        originalValues.email = userProfile.email || '';
        originalValues.phone = userProfile.preferences?.mobile || '';
        originalValues.gender = userProfile.preferences?.gender || '';
        originalValues.password = '';
      }
    });
  }
};


/*profile icon*/
            
function toggleDropdown() {
    const dropdown = document.getElementById("dropdownMenu");
    dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    }

  
    window.onclick = function(event) {
    if (!event.target.matches('.profile-icon')) {
        const dropdown = document.getElementById("dropdownMenu");
        if (dropdown && dropdown.style.display === "block") {
            dropdown.style.display = "none";
        }
        }
    }

function goHome() {
    window.location.href = 'Home page.html';  
}

function faq(){
    window.location.href = 'FAQ.html';
}

function blogs(){
    window.location.href = 'blogs.html';
}

function contact(){
    window.location.href = 'Contact.html';
}

function editprofile(){
    window.location.href = 'edit profile2.html';
}
            
function logout(){
    localStorage.removeItem('userProfile');
    localStorage.removeItem('firebaseIdToken');
    window.location.href = 'myproject design 2.html';
}

function deleteProfile() {
    if (confirm('Are you sure you want to delete your profile? This action cannot be undone.')) {
        const idToken = localStorage.getItem('firebaseIdToken');
        if (!idToken) {
            alert('You are not logged in.');
            window.location.replace('myproject design 2.html');
            return;
        }
        fetch('http://localhost:5000/api/delete-profile', {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + idToken
            }
        })
        .then(response => {
            if (response.ok) {
                alert('Your profile has been deleted.');
                // Clear all authentication/session data
                localStorage.removeItem('firebaseIdToken');
                localStorage.removeItem('userProfile');
                localStorage.removeItem('tripDetails');
                localStorage.removeItem('destination');
                window.location.replace('myproject design 2.html');
            } else {
                return response.json().then(data => { throw new Error(data.error || 'Failed to delete profile.'); });
            }
        })
        .catch(err => {
            alert('Error: ' + err.message);
        });
    }
    // If No, do nothing (alert closes automatically)
}

</script>

<footer>
    © 2025 Bonvoyage- Travel Packing Assistant. All rights reserved.
  </footer>
 
</body>
</html>
